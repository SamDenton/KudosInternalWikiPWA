@page "/chat"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.Net.Http.Json
<AuthorizeView>
    <Authorized>
        <div class="container">
            <section class="side-bar">
                <button @onclick="SaveConversationAndStartNew" class="newChatBtn">New chat</button>
                <div class="history">
                    @foreach (var item in history)
                    {
                        var chatId = item.Key;
                        <p @onclick="() => LoadConversation(chatId)">
                            <Editor Id="@chatId"
                                Inline=true
                                CloudChannel="5"
                                Disable=false
                                Conf="@editorConfHeaders"
                                ApiKey="@TinyAPIKey"
                                ClassName="counterEditor"
                                @bind-Value="conversationNames[chatId]" 
                                />
                                @* @onchange="@(args => UpdateConversationName(chatId, (ChangeEventArgs)args))" *@ 
                        </p>
                    }
                </div>
                <nav>
                    <p>Chat History (Currently Deleted on refresh)</p>
                </nav>
            </section>
            <section class="main">
                <h1>GPTSam</h1>
                <div id="conversation">
                    @foreach (var message in currentConversation)
                    {
                        if (message.role == "user")
                        {
                            <div class="message-container user">
                                <div class="text-bubble">@message.content</div>
                                <div class="name">@context.User.Identity?.Name</div>
                            </div>
                        }
                        else if (message.role == "assistant")
                        {
                            <div class="message-container assistant">
                                <div class="text-bubble">@message.content</div>
                                <div class="name">GPTSam</div>
                            </div>
                        }
                    }
                </div>
                <div class="bottom-section">
                    <div class="input-container">
                        <input @bind="inputText" class="inputText" @onkeydown="@(args => HandleKeyPress(args))"  />
                        <div @onclick="GetMessage" id="submit" class="oi oi-chevron-right"></div>
                    </div>
                </div>
                <p class="info">ChatGPT Mar 4 Version</p>
            </section>
        </div>
    </Authorized>
</AuthorizeView>

@code {

    @* Should look into NeMo Guard rails *@


    private string API_KEY;
    private string inputText = "";
    private string currentConversationId;
    private string TinyAPIKey = "7so5re0foy5ocvnv7m3m3rznoi0hiar7wrg9w0hk2bkgfshl";
    private int chatCount = 0;
    private Dictionary<string, List<Message>> history = new Dictionary<string, List<Message>>();
    private List<Message> currentConversation = new List<Message>();
    private Dictionary<string, string> conversationNames = new Dictionary<string, string>();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            @* Would be fun to try and send some wiki data as context.  I think if I just implement my existing search function here, sanitise and include and part of the system message, that should work. *@
            var getFromTokens = await Http.GetAsync("ChatToken.txt");
            API_KEY = await getFromTokens.Content.ReadAsStringAsync();
            currentConversationId = $"Conversation {Guid.NewGuid()}";
            currentConversation.Add(new Message { role = "system", content = "You are a helpful, polite chatbot assistant built by Kudos Software to assist our customers with issues before they are raised to the support team.  You will only answer questions related to EPoS systems, tills, printers and gift aid.  If other questions are asked, you will reply: Sorry, that query is outside my scope, please contact support." });
        }
    }

    private async Task GetMessage()
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, "https://api.openai.com/v1/chat/completions");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", API_KEY);

            currentConversation.Add(new Message { role = "user", content = inputText });
            var requestBody = new
            {
                model = "gpt-3.5-turbo",
                messages = currentConversation.ToArray(),
                max_tokens = 1000
            };

            ClearInput();

            request.Content = JsonContent.Create(requestBody);
            request.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/json");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var data = await response.Content.ReadFromJsonAsync<OpenAIResponse>();
            var outputText = data.choices[0].message.content;
            currentConversation.Add(new Message { role = "assistant", content = outputText });

            StateHasChanged();
            Console.WriteLine(outputText);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            currentConversation.Add(new Message { role = "error", content = "OpenAI API unavailable or out of credits" });
            Console.WriteLine("OpenAI API unavailable or out of credits");
        }
    }

    private void ClearInput()
    {
        inputText = "";
    }

    private void SaveConversation()
    {
        if (currentConversation.Count > 0)
        {
            history[currentConversationId] = new List<Message>(currentConversation);
            if (!conversationNames.ContainsKey(currentConversationId))
            {
                int maxLength = 20;
                string shortName = inputText.Substring(0, Math.Min(inputText.Length, maxLength));
                conversationNames[currentConversationId] = shortName;
            }
            StateHasChanged();
        }
    }

    private void SaveConversationAndStartNew()
    {
        SaveConversation();
        currentConversation.Clear();
        currentConversationId = $"Conversation {Guid.NewGuid()}";
        currentConversation.Add(new Message { role = "system", content = "You are a helpful, polite chatbot assistant built by Kudos Software to assist our customers with issues before they are raised to the support team.  You will only answer questions related to EPoS systems, tills, printers and gift aid.  If other questions are asked, you will reply Sorry, that query is outside my scope, please contact support." });
        StateHasChanged();
    }
    private void LoadConversation(string conversationName)
    {
        SaveConversation();

        if (history.ContainsKey(conversationName))
        {
            currentConversationId = conversationName;
            currentConversation = new List<Message>(history[conversationName]);
            StateHasChanged();
        }
    }

    private void UpdateConversationName(string conversationId, ChangeEventArgs args)
    {
        conversationNames[conversationId] = args.Value.ToString();
    }

    private async Task HandleKeyPress(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await Task.Delay(10);
            await GetMessage();
        }
    }

    public class OpenAIResponse
    {
        public Choice[] choices { get; set; }
    }

    public class Choice
    {
        public Message message { get; set; }
    }

    public class Message
    {
        public string role { get; set; }
        public string content { get; set; }
    }

    private Dictionary<string, object> editorConfHeaders = new Dictionary<string, object>  {
    @* Would like to condence toolbar in to a few dropdowns, but converting JS syntax to C# is a pain *@
        {"plugins", "autolink media link image table lists advlist code emoticons wordcount importcss autoresize quickbars codesample help"}, //imagetools spellchecker - Removed as imagetools now premium and spellchecker depricated
        {"contextmenu", "copy paste | link image imagetools table lists undo redo | inserttable | cell row column deletetable | help"},
        {"table_toolbar", "tableprops tabledelete | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol"},
        {"quickbars_selection_toolbar", "undo redo | bold italic underline strikethrough | fontfamily fontsize | blocks | bullist numlist | alignleft aligncenter alignright alignjustify | outdent indent | forecolor backcolor | blockquote quicklink | charmap emoticons | print | insertfile image media template link anchor codesample | removeformat"},
        {"toolbar", "false"},
        {"menubar", "false"},
        {"block_formats", "Paragraph=p; Heading 1=h1; Heading 2=h2; Heading 3=h3; Heading 4=h4; Heading 5=h5; Heading 6=h6;"},
        {"quickbars_insert_toolbar", "quicktable image media codesample" },
        {"width", "100%"},
        {"min_width", "100%"},
        {"height", "100%"}, @* Using autosize plugin, height property should be ignored. Min_height still respected *@
        {"min_height", 100},
        {"autoresize_bottom_margin", 30},
        {"skin", "oxide-dark"},
        {"content_css", "dark"},
        {"autosave_ask_before_unload", "true"},
        {"paste_data_images", "false"},
        {"paste_as_text", "true"},
        {"resize", "true"},
        {"forced_root_block", ""}
    @* Allows user to resize using bottom right corner.  Should still respect min height and width *@
    };
}